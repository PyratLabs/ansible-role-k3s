---

- name: Ensure that the manifests directory exists
  ansible.builtin.file:
    state: directory
    path: "{{ k3s_server_manifests_dir }}"
    mode: 0755

- name: Deploy tigera operator to k3s manifest directory
  ansible.builtin.get_url:
    url: "{{ calico_tigera_manifest }}"
    dest: "{{ k3s_server_manifests_dir }}/tigera-operator.yaml"
    mode: 0644

- name: Deploy configuration to k3s manifest directory
  ansible.builtin.template:
    src: "calico-installation.yaml.j2"
    dest: "{{ k3s_server_manifests_dir }}/calico-installation.yaml"
    mode: 0644

- name: Deploy BGP-peer to k3s manifest directory
  ansible.builtin.template:
    src: "calico-bgppeer.yaml.j2"
    dest: "{{ k3s_server_manifests_dir }}/calico-bgppeer.yaml"
    mode: 0644
  when:
  - calico_bgp is defined
  - calico_bgp

- name: Deploy BGP-configuration to k3s manifest directory
  ansible.builtin.template:
    src: "calico-bgpconfiguration.yaml.j2"
    dest: "{{ k3s_server_manifests_dir }}/calico-bgpconfiguration.yaml"
    mode: 0644
  when:
  - calico_bgp is defined
  - calico_bgp
